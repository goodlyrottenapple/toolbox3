-- {-# SMT-command ('set-logic 'QF_UFSLIAFS) #-}
-- {-# SMT-log-enabled true #-}
-- {-# SMT-log-level 1 #-}

infixl 1 &&
infix 2 âŠ¢ , âˆˆ , âˆ‰, â‰¡, â©¸, â©µ
infix 3 \\ , \
infixr 3 â†’ , -< , >, âˆ·, $
infixl 4 âˆ§, âˆ¨, ;, âˆª, âˆ©


smt-builtin (â‰¡) ['=] : {a : Type} -> a -> a -> Prop end
smt-builtin (âˆˆ) [member] : {a : Type} -> a -> Set a -> Prop end
smt-builtin (âˆª) [union] : {a : Type} -> Set a -> Set a -> Set a end
smt-builtin (âˆ©) [intersection] : {a : Type} -> Set a -> Set a -> Set a end
smt-builtin (\) [setminus] : {a : Type} -> Set a -> Set a -> Set a end
smt-builtin singleton [singleton] : {a : Type} -> a -> Set a end

smt-builtin (&&) [and] : Prop -> Prop -> Prop end
smt-builtin Â¬ [not] : Prop -> Prop end

smt-def (âˆ‰) : {a : Type} -> (x : a) -> (X : Set a) -> Prop where
  ('not ('member x X))
end

smt-def (\\) : {a : Type} -> (X : Set a) -> (x : a) -> Set a where 
  ('setminus X ('singleton x))
end

smt-def infer : {a : Type} -> (x : a) -> Prop where 
  ('= x x)
end

data Nat : * where
    0 : Nat |
    Suc : Nat -> Nat
end


data Vec : Type -> Nat -> Type where
  NilV : {a : Type} -> Vec a 0 |
  ConsV : {a : Type} -> {n : Nat} -> a -> Vec a n -> Vec a (Suc n)
end

language LaTeX


translation Vec to LaTeX where
  NilV -> '''\varempty''' |
  ConsV a v -> "\cons{#a}{#v}"
end

data List : Set Name -> (Set Name -> *) -> * where
    âˆ… : -- {ğ“ : Set Name} -> [infer ğ“] -> -- this is a bit of a hack to force the SMT solver to come up with X automatically
        {Ï„ : Set Name -> *} -> List {| |} Ï„
  | (âˆ·) : {X : Set Name} -> {Y : Set Name} -> {Z : Set Name} -> {Ï„ : Set Name -> *} -> 
        (x : Ï„ X) -> List Y Ï„ -> [Z â‰¡ X âˆª Y] -> List Z Ï„
end

translation List to LaTeX where
    âˆ… -> ""
  | (âˆ·) x xs -> "#{x} , #{xs}"
end

data Trm : Set Name -> * where 
    var : {ğ“ : Set Name} -> (n : Name) -> [n âˆˆ ğ“] -> Trm ğ“
  | const : {ğ“ : Set Name} -> Name -> Trm ğ“
  | fun : {ğ“ : Set Name} -> Name -> List ğ“ Trm -> Trm ğ“
end

def empty : List {| |} Trm where
  âˆ…
end


data SubstList : Set Name -> Set Name -> (Set Name -> *) -> * where
    Nil : {ğ“ : Set Name} -> {ğ“â‚‚ : Set Name} -> {Ï„ : Set Name -> *} -> SubstList ğ“ ğ“â‚‚ Ï„
  | Cons : {ğ“ : Set Name} -> 
        {ğ“â‚â‚ : Set Name} -> {ğ“â‚‚â‚ : Set Name} -> 
        {ğ“â‚â‚‚ : Set Name} -> {ğ“â‚‚â‚‚ : Set Name} -> 
        {Ï„ : Set Name -> *} ->
        (x : Name) -> 
        -- [ x âˆ‰ ğ“ && x âˆ‰ ğ“â‚â‚ && x âˆ‰ ğ“â‚‚â‚ ] -> 
        [ x âˆ‰ ğ“ && x âˆ‰ ğ“â‚â‚ ] -> 
        (s : Ï„ ğ“) -> SubstList ğ“â‚â‚ ğ“â‚‚â‚ Ï„ -> 
        [ğ“â‚â‚‚ â‰¡ ğ“â‚â‚ âˆª (singleton x) && ğ“â‚‚â‚‚ â‰¡ ğ“â‚‚â‚ âˆª ğ“] -> 
        SubstList ğ“â‚â‚‚ ğ“â‚‚â‚‚ Ï„
end


data F : Set Name -> * where
    R : Name -> {ğ“ : Set Name} -> List ğ“ Trm -> F ğ“
  | (â©µ) : {ğ“ : Set Name} -> Trm ğ“ -> Trm ğ“ -> F ğ“
  | âŠ¤ : {ğ“ : Set Name} -> F ğ“
  | âŠ¥ : {ğ“ : Set Name} -> F ğ“
  | (âˆ§) : {ğ“ : Set Name} -> F ğ“ -> F ğ“ -> F ğ“
  | (âˆ¨) : {ğ“ : Set Name} -> F ğ“ -> F ğ“ -> F ğ“
  | (â†’) : {ğ“ : Set Name} -> F ğ“ -> F ğ“ -> F ğ“
  | (-<) : {ğ“ : Set Name} -> F ğ“ -> F ğ“ -> F ğ“
  | âˆ€ : {ğ“ : Set Name} -> {ğ“â‚‚ : Set Name} -> (x : Name) -> [ x âˆˆ ğ“ ] -> F ğ“ -> [ ğ“â‚‚ â‰¡ ğ“ \\ x ] -> F ğ“â‚‚
  | âˆƒ : (x : Name) -> {ğ“ : Set Name} -> [ x âˆˆ ğ“ ] -> F ğ“ -> {ğ“â‚‚ : Set Name} -> [ ğ“â‚‚ â‰¡ ğ“ \\ x ] -> F ğ“â‚‚
  | âˆ˜ : {ğ“ : Set Name} -> {ğ“â‚‚ : Set Name} -> (x : Name) -> [ x âˆ‰ ğ“ ] -> F ğ“ -> [ ğ“â‚‚ â‰¡ ğ“ âˆª (singleton x) ] -> F ğ“â‚‚
  | subst : {ğ“ : Set Name} -> {ğ“â‚‚ : Set Name} -> SubstList ğ“ ğ“â‚‚ Trm -> F ğ“ -> F ğ“â‚‚
end

translation F to LaTeX where
    R n lst -> "#{n}(#{lst})"
  | (â©µ) a b -> "#{a} = #{b}"
  | âŠ¤ -> "\top"
  | âŠ¥ -> "\bot"
  | (âˆ§) a b -> "#{a} \wedge #{b}"
  | (âˆ¨) a b -> "#{a} \vee #{b}"
  | (â†’) a b -> "#{a} \to #{b}"
  | âˆ€ x a -> "\forall #{x}.\,#{a}"
  | âˆ˜ x a -> "\sub{\circ}{\!#{x}} #{a}"
end

data S : Set Name -> * where
    â†‘ : {ğ“ : Set Name} -> F ğ“ -> S ğ“
  | Ieq : {ğ“ : Set Name} -> Trm ğ“ -> Trm ğ“ -> S ğ“
  | I : {ğ“ : Set Name} -> S ğ“
  | IR : Name -> {ğ“ : Set Name} -> List ğ“ Trm -> S ğ“
  | (;) : {ğ“ : Set Name} -> S ğ“ -> S ğ“ -> S ğ“
  | (>) : {ğ“ : Set Name} -> S ğ“ -> S ğ“ -> S ğ“
  
  | Q : {ğ“ : Set Name} -> {ğ“â‚‚ : Set Name} -> (x : Name) -> [ x âˆˆ ğ“ ] -> S ğ“ -> [ ğ“â‚‚ â‰¡ ğ“ \\ x ] -> S ğ“â‚‚
  | âŠ™ : {ğ“ : Set Name} -> {ğ“â‚‚ : Set Name} -> (x : Name) -> [ x âˆ‰ ğ“ ] -> S ğ“ -> [ ğ“â‚‚ â‰¡ ğ“ âˆª (singleton x) ] -> S ğ“â‚‚
  | substS : {ğ“ : Set Name} -> {ğ“â‚‚ : Set Name} -> SubstList ğ“â‚‚ ğ“â‚‚ Trm -> S ğ“ -> S ğ“â‚‚
end


translation S to LaTeX where
    â†‘ f -> "#{f}"
  | I -> "\mathbb{I}"
  | IR n lst -> "\bf{#{n}}(#{lst})"
  | (;) s t -> "#{s} ; #{t}"
  | (>) s t -> "#{s} > #{t}"
  | Q x s -> "\bf{Q}#{x}.\,#{s}"
  | âŠ™ x s -> "\sub{\bigcirc}{\!#{x}} #{s}"

end


data (âŠ¢) : {ğ“ : Set Name} -> S ğ“ -> S ğ“ -> Type where
  IdIR    : {r : Name} -> {ğ“ : Set Name} -> {ts : List ğ“ Trm} -> 

            --------------------
            IR r ts âŠ¢ â†‘ (R r ts) 
  |
  AllR    : {ğ“â‚“ : Set Name} -> {ğ“â‚ : Set Name} -> 
            {X : S ğ“â‚“} -> {x : Name} -> {A : F ğ“â‚} -> 

          X âŠ¢ Q x (â†‘ A) ->
          -------------
          X âŠ¢ â†‘ (âˆ€ x A)
  | 
  QâŠ™Disp  : {ğ“â‚“ : Set Name} -> {ğ“áµ§ : Set Name} -> 
            {X : S ğ“â‚“} -> {Y : S ğ“áµ§} -> {x : Name} ->

            Y âŠ¢ Q x X ->
            ---------
            âŠ™ x Y âŠ¢ X
  | 
  QâŠ™Disp2 : {ğ“â‚“ : Set Name} -> {ğ“áµ§ : Set Name} -> 
            {X : S ğ“â‚“} -> {Y : S ğ“áµ§} -> {x : Name} ->

            (âŠ™ x Y) âŠ¢ X ->
            -----------
            Y âŠ¢ (Q x X)
  | 
  âˆ˜R :     {ğ“â‚“ : Set Name} -> {ğ“â‚ : Set Name} -> 
         {X : S ğ“â‚“} -> {x : Name} -> {A : F ğ“â‚} -> 

           X âŠ¢ âŠ™ x (â†‘ A) ->
           -------------
           X âŠ¢ â†‘ (âˆ˜ x A)
  | 
  âŠ™mon :   {ğ“ : Set Name} -> {ğ“â‚‚ : Set Name} -> 
           {X : S ğ“} -> {Y : S ğ“} -> {x : Name} ->

                  X âŠ¢ Y -> 
         -----------------------
         âŠ™ {ğ“} {ğ“â‚‚} x X âŠ¢ âŠ™ x Y
  | 
  IRL :    {r : Name} -> {ğ“ : Set Name} -> 
           {X : S ğ“} -> {ts : List ğ“ Trm} -> 

         IR r ts âŠ¢ X ->
         --------------
         â†‘ (R r ts) âŠ¢ X
end


translation (âŠ¢) to LaTeX where
    IdIR : x âŠ¢ y -> "\AXC{}\RightLabel{$\sub{Id}{\mathbb{I}R}$}\n\UIC{$#{x} \vdash #{y}$}"
  | AllR p : x âŠ¢ y -> "#{p}\RightLabel{$\sub{\forall}{R}$}\n\UIC{$#{x} \vdash #{y}$}"
  | QâŠ™Disp2 p : x âŠ¢ y -> "#{p}\RightLabel{(Q/âŠ™)}\n\UIC{$#{x} \vdash #{y}$}"
  | âˆ˜R p : x âŠ¢ y -> "#{p}\RightLabel{$\sub{âˆ˜}{R}$}\n\UIC{$#{x} \vdash #{y}$}"
  | âŠ™mon p : x âŠ¢ y -> "#{p}\RightLabel{âŠ™mon}\n\UIC{$#{x} \vdash #{y}$}"
  | IRL p : x âŠ¢ y -> "#{p}\RightLabel{$\sub{\mathbb{I} R}{L}$}\n\UIC{$#{x} \vdash #{y}$}"
end


def lemma : â†‘(R 'f âˆ…) âŠ¢ â†‘(âˆ€ 'x (âˆ˜ 'x (R 'f âˆ…))) where
    (AllR (QâŠ™Disp2 (âˆ˜R (âŠ™mon (IRL IdIR)))))
end

translate lemma to LaTeX where
  output = "./out.tex"
end

-- translate lemma to JSON where
--   output = "./out.tex"
-- end
